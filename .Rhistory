setwd("~/Desktop/Projects/V1.0/single_cell")
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE
)
library(Signac)
library(Seurat)
counts <- Read10X_h5("~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_filtered_peak_bc_matrix.h5")
meta <- read.csv("~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_singlecell.csv.gz", header = TRUE, row.names = 1)
chrom_assay <- CreateChromatinAssay(
counts = counts,
sep = c(":", "-"),
genome = "mm10",
fragments = "~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_fragments.tsv.gz",
min.cells = 10,
min.features = 200
)
data <- CreateSeuratObject(counts = chrom_assay, assay = "peaks", meta.data = meta)
library(GenomeInfoDb)
library(EnsDb.Mmusculus.v79)
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)
seqlevelsStyle(annotations) <- "UCSC"
Annotation(data) <- annotations
data <- NucleosomeSignal(object = data)
data <- TSSEnrichment(object = data, fast = FALSE)
data$blacklist_ratio <- data$blacklist_region_fragments / data$peak_region_fragments
data$pct_reads_in_peaks <- data$peak_region_fragments / data$passed_filters * 100
VlnPlot(
object = data,
features = c("peak_region_fragments", "pct_reads_in_peaks", "blacklist_ratio", "nucleosome_signal", "TSS.enrichment"),
pt.size = 0.1,
ncol = 5
)
data <- subset(
x = data,
subset = peak_region_fragments > 3000 &
peak_region_fragments < 20000 &
pct_reads_in_peaks > 15 &
blacklist_ratio < 0.05 &
nucleosome_signal < 4 &
TSS.enrichment > 2
)
low_prf <- quantile(data[["peak_region_fragments"]]$peak_region_fragments, probs = 0.02)
hig_prf <- quantile(data[["peak_region_fragments"]]$peak_region_fragments, probs = 0.98)
low_prp <- quantile(data[["pct_reads_in_peaks"]]$pct_reads_in_peaks, probs = 0.02)
high_blr <- quantile(data[["blacklist_ratio"]]$blacklist_ratio, probs = 0.98)
hig_ns <- quantile(data[["nucleosome_signal"]]$nucleosome_signal, probs = 0.98)
low_ts <- quantile(data[["TSS.enrichment"]]$TSS.enrichment, probs = 0.02)
data <- subset(
x = data,
subset = peak_region_fragments > low_prf &
peak_region_fragments < hig_prf &
pct_reads_in_peaks > low_prp &
blacklist_ratio < high_blr &
nucleosome_signal < hig_ns &
TSS.enrichment > low_ts
)
data <- RunTFIDF(data)
data <- FindTopFeatures(data, min.cutoff = "q0")
data <- RunSVD(data)
data <- RunUMAP(object = data, reduction = "lsi", dims = 2:30)
data <- FindNeighbors(object = data, reduction = "lsi", dims = 2:30)
data <- FindClusters(object = data, verbose = FALSE, algorithm = 3)
DimPlot(object = data, label = TRUE) + NoLegend()
import_atac <- function(count_path, meta_path, fragment_path) {
counts <- Read10X_h5(filename = count_path)
meta <- read.csv(file = meta_path, header = TRUE, row.names = 1)
chrom_assay <- CreateChromatinAssay(
counts = counts,
sep = c(":", "-"),
genome = "mm10",
fragments = fragment_path,
min.cells = 10,
min.features = 200
)
data <- CreateSeuratObject(counts = chrom_assay, assay = "peaks", meta.data = meta)
Annotation(data) <- annotations
data <- NucleosomeSignal(object = data)
data <- TSSEnrichment(object = data, fast = FALSE)
data$blacklist_ratio <- data$blacklist_region_fragments / data$peak_region_fragments
data$pct_reads_in_peaks <- data$peak_region_fragments / data$passed_filters * 100
low_prf <- quantile(data[["peak_region_fragments"]]$peak_region_fragments, probs = 0.02)
hig_prf <- quantile(data[["peak_region_fragments"]]$peak_region_fragments, probs = 0.98)
low_prp <- quantile(data[["pct_reads_in_peaks"]]$pct_reads_in_peaks, probs = 0.02)
high_blr <- quantile(data[["blacklist_ratio"]]$blacklist_ratio, probs = 0.98)
hig_ns <- quantile(data[["nucleosome_signal"]]$nucleosome_signal, probs = 0.98)
low_ts <- quantile(data[["TSS.enrichment"]]$TSS.enrichment, probs = 0.02)
data <- subset(
x = data,
subset = peak_region_fragments > low_prf &
peak_region_fragments < hig_prf &
pct_reads_in_peaks > low_prp &
blacklist_ratio < high_blr &
nucleosome_signal < hig_ns &
TSS.enrichment > low_ts
)
return(data)
}
young <- import_atac(
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_filtered_peak_bc_matrix.h5",
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_singlecell.csv.gz",
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723631_Young_HSC_fragments.tsv.gz"
)
old <- import_atac(
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723632_Aged_HSC_filtered_peak_bc_matrix.h5",
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723632_Aged_HSC_singlecell.csv.gz",
"~/Desktop/Projects/V1.0/single_cell/data/GSM5723632_Aged_HSC_fragments.tsv.gz"
)
young$dataset <- "young"
old$dataset <- "old"
data <- merge(young, old)
data <- FindTopFeatures(data, min.cutoff = "q0")
data <- RunTFIDF(data)
data <- RunSVD(data)
data <- RunUMAP(object = data, reduction = "lsi", dims = 2:30)
data <- FindNeighbors(object = data, reduction = "lsi", dims = 2:30)
data <- FindClusters(object = data, verbose = FALSE, algorithm = 3, resolution = 0.4)
DimPlot(object = data, label = TRUE, group.by = "dataset") + NoLegend()
gene.activities <- GeneActivity(data)
data[["RNA"]] <- CreateAssayObject(counts = gene.activities)
data <- NormalizeData(
object = data,
assay = "RNA",
normalization.method = "LogNormalize",
scale.factor = median(data$nCount_RNA)
)
DefaultAssay(data) <- "RNA"
FeaturePlot(
object = data,
features = c("Kit", "Pecam1", "Itgam"),
max.cutoff = "q95"
)
DefaultAssay(data) <- "peaks"
da_peaks <- FindMarkers(
object = data,
ident.1 = rownames(data[[]][data$dataset == "old", ]),
ident.2 = rownames(data[[]][data$dataset == "young", ]),
min.pct = 0.05,
test.use = "LR",
latent.vars = "peak_region_fragments"
)
da_peaks$closest_gene <- ClosestFeature(data, regions = rownames(da_peaks))$gene_name
da_peaks$distance <- ClosestFeature(data, regions = rownames(da_peaks))$distance
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE
)
CoveragePlot(
object = data,
region = rownames(da_peaks)[2],
extend.upstream = 10000,
extend.downstream = 5000,
group.by = "dataset"
)
plot1 <- VlnPlot(object = data, features = rownames(da_peaks)[2], group.by = "dataset")
plot2 <- FeaturePlot(object = data, features = rownames(da_peaks)[2], max.cutoff = "q95")
plot1 | plot2
source("~/Desktop/Projects/V1.0/single_cell/HSC_scRNA-ATAC_seq.Rmd")
